<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="/logo.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EzMath - Fun Math for Kids!</title>

  <!-- PWA Meta Tags -->
  <meta name="description" content="Kid-friendly math learning game with multiple game modes and progress tracking">
  <meta name="theme-color" content="#9333ea">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="EzMath">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <div id="app" x-data="{}" x-init="$store.profile.activeProfile?.equippedItems?.theme && Themes.applyTheme($store.profile.activeProfile.equippedItems.theme)">

    <!-- Profile Selection Screen -->
    <div x-show="$store.view.current === 'home'" x-cloak class="min-h-screen flex items-center justify-center p-4">
      <div class="card max-w-md w-full text-center">
        <div class="mb-4 flex justify-center">
          <img src="/logo.png" alt="EzMath Logo" class="w-48 h-48 rounded-full" />
        </div>
        <p class="text-gray-500 mb-6">Fun math practice for everyone!</p>

        <!-- PWA Install Button -->
        <div x-show="$store.view.showPWAInstall" class="mb-6">
          <button
            @click="window.installPWA()"
            class="w-full flex items-center justify-center gap-3 p-4 rounded-2xl bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white transition-all shadow-lg hover:shadow-xl"
          >
            <span class="text-2xl">üì±</span>
            <div class="text-left">
              <div class="font-bold text-lg">Install EzMath</div>
              <div class="text-purple-100 text-sm">Play offline anytime!</div>
            </div>
          </button>
        </div>

        <!-- Existing Profiles -->
        <template x-if="$store.profile.hasProfiles && !$store.view.showCreateProfile">
          <div>
            <h2 class="text-xl font-bold text-gray-700 mb-4">Who's playing?</h2>
            <div class="space-y-3 mb-6">
              <template x-for="profile in $store.profile.profiles" :key="profile.id">
                <button
                  @click="$store.profile.selectProfile(profile.id); $store.view.current = 'menu'"
                  class="w-full flex items-center gap-4 p-4 rounded-2xl bg-purple-50 hover:bg-purple-100 transition-all border-2 border-transparent hover:border-purple-300"
                >
                  <span class="text-4xl" x-text="profile.avatar"></span>
                  <div class="text-left flex-1">
                    <div class="font-bold text-lg text-gray-800" x-text="profile.name"></div>
                    <div class="text-sm text-gray-500">
                      <span x-text="profile.stats.totalProblems"></span> problems solved
                    </div>
                  </div>
                  <span class="text-purple-400">‚Üí</span>
                </button>
              </template>
            </div>
            <button @click="$store.view.showCreateProfile = true" class="btn btn-secondary w-full">
              + Add Player
            </button>
          </div>
        </template>

        <!-- Create Profile Form -->
        <template x-if="!$store.profile.hasProfiles || $store.view.showCreateProfile">
          <div>
            <h2 class="text-xl font-bold text-gray-700 mb-4" x-text="$store.profile.hasProfiles ? 'Add New Player' : 'Create Your Profile'"></h2>

            <div class="mb-4">
              <input
                type="text"
                x-model="$store.view.newProfileName"
                placeholder="Your name"
                class="w-full px-4 py-3 text-lg rounded-xl border-2 border-purple-200 focus:border-purple-500 focus:outline-none text-center"
                maxlength="20"
              />
            </div>

            <div class="mb-6">
              <p class="text-sm text-gray-500 mb-2">Pick your avatar:</p>
              <div class="flex flex-wrap justify-center gap-2">
                <template x-for="avatar in AVATARS" :key="avatar">
                  <button
                    @click="$store.view.newProfileAvatar = avatar"
                    class="avatar-btn"
                    :class="{ 'selected': $store.view.newProfileAvatar === avatar }"
                    x-text="avatar"
                  ></button>
                </template>
              </div>
            </div>

            <div class="flex gap-3">
              <button
                x-show="$store.profile.hasProfiles"
                @click="$store.view.showCreateProfile = false"
                class="btn bg-gray-300 hover:bg-gray-400 flex-1"
              >
                Cancel
              </button>
              <button
                @click="if($store.view.newProfileName.trim()) { $store.profile.createProfile($store.view.newProfileName, $store.view.newProfileAvatar); $store.view.newProfileName = ''; $store.view.showCreateProfile = false; $store.view.current = 'menu'; }"
                :disabled="!$store.view.newProfileName.trim()"
                class="btn btn-primary flex-1"
                :class="{ 'opacity-50 cursor-not-allowed': !$store.view.newProfileName.trim() }"
              >
                Let's Go!
              </button>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Main Menu -->
    <div x-show="$store.view.current === 'menu'" x-cloak class="min-h-screen flex items-center justify-center p-4">
      <div class="card max-w-md w-full text-center">
        <!-- Profile Header -->
        <div class="flex items-center justify-between mb-6">
          <button @click="$store.view.current = 'home'" class="text-2xl hover:scale-110 transition-transform">‚Üê</button>
          <div class="flex flex-col items-center gap-1">
            <div class="flex items-center gap-2">
              <span class="text-3xl" x-text="$store.profile.activeProfile?.avatar"></span>
              <span class="font-bold text-lg" x-text="$store.profile.activeProfile?.name"></span>
            </div>
            <div class="flex items-center gap-1 bg-amber-100 px-3 py-1 rounded-full">
              <span>‚≠ê</span>
              <span class="font-bold text-amber-600" x-text="$store.profile.activeProfile?.stats.stars || 0"></span>
            </div>
          </div>
          <div class="flex gap-2">
            <button @click="$store.view.current = 'shop'" class="text-2xl hover:scale-110 transition-transform" title="Shop">üè™</button>
            <button @click="$store.view.current = 'stats'" class="text-2xl hover:scale-110 transition-transform" title="Stats">üìä</button>
          </div>
        </div>

        <h2 class="text-2xl font-bold text-purple-600 mb-6">Choose Your Game</h2>

        <!-- Pet Display -->
        <div
          @click="$store.view.current = 'pet'"
          class="mb-6 bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-2xl border-2 border-purple-200 cursor-pointer hover:shadow-lg hover:border-purple-300 transition-all"
        >
          <div class="flex items-center gap-4">
            <div class="text-6xl" x-text="PetSystem.getPetEmoji($store.profile.activeProfile?.pet?.stage || 0)"></div>
            <div class="flex-1">
              <div class="font-bold text-lg text-purple-700" x-text="($store.profile.activeProfile?.pet?.name || 'Nora')"></div>
              <div class="text-sm text-purple-600" x-text="PetSystem.getPetMessage($store.profile.activeProfile?.pet?.stage || 0)"></div>
              <div class="mt-2">
                <div class="h-2 bg-purple-200 rounded-full overflow-hidden">
                  <div
                    class="h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all"
                    :style="'width: ' + PetSystem.getEvolutionProgress($store.profile.activeProfile?.stats.totalProblems || 0) + '%'"
                  ></div>
                </div>
                <div class="text-xs text-gray-500 mt-1">
                  <span x-text="PetSystem.getProblemsToNextEvolution($store.profile.activeProfile?.stats.totalProblems || 0)"></span> problems to next evolution
                </div>
              </div>
            </div>
            <div class="text-3xl text-purple-500">‚Üí</div>
          </div>
        </div>

        <div class="space-y-4">
          <!-- Darab Mode (Multiplication Tables) -->
          <button
            @click="$store.view.selectedMode = 'sifir'; $store.view.current = 'settings'"
            class="w-full p-5 rounded-2xl bg-gradient-to-r from-amber-500 to-orange-500 text-white hover:from-amber-600 hover:to-orange-600 transition-all shadow-lg hover:shadow-xl"
          >
            <div class="flex items-center gap-4">
              <span class="text-4xl">‚úñÔ∏è</span>
              <div class="text-left">
                <div class="font-bold text-xl">Darab</div>
                <div class="text-amber-200 text-sm">Master multiplication tables 1-12!</div>
              </div>
            </div>
          </button>

          <!-- Bahagi Mode (Division Tables) -->
          <button
            @click="$store.view.selectedMode = 'bahagi'; $store.view.current = 'settings'"
            class="w-full p-5 rounded-2xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white hover:from-emerald-600 hover:to-teal-600 transition-all shadow-lg hover:shadow-xl"
          >
            <div class="flex items-center gap-4">
              <span class="text-4xl">‚ûó</span>
              <div class="text-left">
                <div class="font-bold text-xl">Bahagi</div>
                <div class="text-emerald-200 text-sm">Master division tables 1-12!</div>
              </div>
            </div>
          </button>

          <!-- Tambah Mode (Addition by Difficulty) -->
          <button
            @click="$store.view.selectedMode = 'tambah'; $store.view.current = 'settings'"
            class="w-full p-5 rounded-2xl bg-gradient-to-r from-blue-500 to-indigo-500 text-white hover:from-blue-600 hover:to-indigo-600 transition-all shadow-lg hover:shadow-xl"
          >
            <div class="flex items-center gap-4">
              <span class="text-4xl">‚ûï</span>
              <div class="text-left">
                <div class="font-bold text-xl">Tambah</div>
                <div class="text-blue-200 text-sm">Master addition through all levels!</div>
              </div>
            </div>
          </button>

          <!-- Tolak Mode (Subtraction by Difficulty) -->
          <button
            @click="$store.view.selectedMode = 'tolak'; $store.view.current = 'settings'"
            class="w-full p-5 rounded-2xl bg-gradient-to-r from-rose-500 to-red-500 text-white hover:from-rose-600 hover:to-red-600 transition-all shadow-lg hover:shadow-xl"
          >
            <div class="flex items-center gap-4">
              <span class="text-4xl">‚ûñ</span>
              <div class="text-left">
                <div class="font-bold text-xl">Tolak</div>
                <div class="text-rose-200 text-sm">Master subtraction through all levels!</div>
              </div>
            </div>
          </button>

          <!-- All Operations Mode -->
          <button
            @click="$store.view.selectedMode = 'practice'; $store.view.current = 'settings'"
            class="w-full p-5 rounded-2xl bg-gradient-to-r from-purple-500 to-purple-600 text-white hover:from-purple-600 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl transform hover:scale-102"
          >
            <div class="flex items-center gap-4">
              <span class="text-4xl">üéØ</span>
              <div class="text-left">
                <div class="font-bold text-xl">All Operations</div>
                <div class="text-purple-200 text-sm">Mix all 4 operations - no time limit!</div>
              </div>
            </div>
          </button>

          <!-- Timed Challenge -->
          <button
            @click="$store.view.selectedMode = 'timed'; $store.view.current = 'settings'"
            class="w-full p-5 rounded-2xl bg-gradient-to-r from-cyan-500 to-cyan-600 text-white hover:from-cyan-600 hover:to-cyan-700 transition-all shadow-lg hover:shadow-xl"
          >
            <div class="flex items-center gap-4">
              <span class="text-4xl">‚è±Ô∏è</span>
              <div class="text-left">
                <div class="font-bold text-xl">Timed Challenge</div>
                <div class="text-cyan-200 text-sm">Race against the clock!</div>
              </div>
            </div>
          </button>

          <!-- Level Mode -->
          <button
            @click="$store.view.selectedMode = 'level'; $store.view.current = 'settings'"
            class="w-full p-5 rounded-2xl bg-gradient-to-r from-pink-500 to-pink-600 text-white hover:from-pink-600 hover:to-pink-700 transition-all shadow-lg hover:shadow-xl"
          >
            <div class="flex items-center gap-4">
              <span class="text-4xl">üèÜ</span>
              <div class="text-left">
                <div class="font-bold text-xl">Level Up</div>
                <div class="text-pink-200 text-sm">Progress through levels!</div>
              </div>
            </div>
          </button>
        </div>

        <!-- Quick Stats -->
        <div class="mt-6 pt-6 border-t-2 border-purple-100 grid grid-cols-3 gap-4 text-center">
          <div>
            <div class="text-2xl font-bold text-purple-600" x-text="$store.profile.activeProfile?.stats.totalProblems || 0"></div>
            <div class="text-xs text-gray-500">Solved</div>
          </div>
          <div>
            <div class="text-2xl font-bold text-green-500" x-text="$store.profile.getAccuracy() + '%'"></div>
            <div class="text-xs text-gray-500">Accuracy</div>
          </div>
          <div>
            <div class="text-2xl font-bold text-orange-500" x-text="$store.profile.activeProfile?.stats.bestStreak || 0"></div>
            <div class="text-xs text-gray-500">Best Streak</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Game Settings -->
    <div x-show="$store.view.current === 'settings'" x-cloak class="min-h-screen flex items-center justify-center p-4">
      <div class="card max-w-md w-full">
        <button @click="$store.view.current = 'menu'" class="text-2xl mb-4 hover:scale-110 transition-transform">‚Üê</button>

        <h2 class="text-2xl font-bold text-purple-600 mb-6 text-center">
          <span x-show="$store.view.selectedMode === 'practice'">üéØ All Operations</span>
          <span x-show="$store.view.selectedMode === 'timed'">‚è±Ô∏è Timed Challenge</span>
          <span x-show="$store.view.selectedMode === 'level'">üèÜ Level Mode</span>
          <span x-show="$store.view.selectedMode === 'sifir'">‚úñÔ∏è Darab Mode</span>
          <span x-show="$store.view.selectedMode === 'bahagi'">‚ûó Bahagi Mode</span>
          <span x-show="$store.view.selectedMode === 'tambah'">‚ûï Tambah Mode</span>
          <span x-show="$store.view.selectedMode === 'tolak'">‚ûñ Tolak Mode</span>
        </h2>

        <!-- Difficulty (for practice, timed, tambah, and tolak modes only) -->
        <div x-show="$store.view.selectedMode === 'practice' || $store.view.selectedMode === 'timed' || $store.view.selectedMode === 'tambah' || $store.view.selectedMode === 'tolak'" class="mb-6">
          <h3 class="font-bold text-gray-700 mb-3">Difficulty</h3>
          <div class="flex gap-2">
            <template x-for="(config, key) in DIFFICULTY_CONFIG" :key="key">
              <button
                @click="$store.view.selectedDifficulty = key"
                class="flex-1 py-3 px-2 rounded-xl font-bold transition-all text-sm"
                :class="$store.view.selectedDifficulty === key ? 'bg-purple-500 text-white' : 'bg-purple-100 text-purple-600 hover:bg-purple-200'"
                x-text="key.charAt(0).toUpperCase() + key.slice(1)"
              ></button>
            </template>
          </div>
        </div>

        <!-- Operations (for practice and timed modes only) -->
        <div x-show="$store.view.selectedMode === 'practice' || $store.view.selectedMode === 'timed'" class="mb-6">
          <h3 class="font-bold text-gray-700 mb-3">Operations</h3>
          <div class="flex gap-2 justify-center">
            <template x-for="(symbol, op) in OPERATION_SYMBOLS" :key="op">
              <button
                @click="$store.view.toggleOperation(op)"
                class="w-14 h-14 rounded-xl text-2xl font-bold transition-all"
                :class="$store.view.selectedOperations.includes(op) ? 'bg-purple-500 text-white' : 'bg-purple-100 text-purple-600 hover:bg-purple-200'"
                x-text="symbol"
              ></button>
            </template>
          </div>
        </div>

        <!-- Time Limit (timed mode only) -->
        <div x-show="$store.view.selectedMode === 'timed'" class="mb-6">
          <h3 class="font-bold text-gray-700 mb-3">Time Limit</h3>
          <div class="flex gap-2">
            <template x-for="time in [60, 90, 120]" :key="time">
              <button
                @click="$store.view.selectedTime = time"
                class="flex-1 py-3 rounded-xl font-bold transition-all"
                :class="$store.view.selectedTime === time ? 'bg-cyan-500 text-white' : 'bg-cyan-100 text-cyan-600 hover:bg-cyan-200'"
              >
                <span x-text="time"></span>s
              </button>
            </template>
          </div>
        </div>

        <!-- Level Mode Info -->
        <div x-show="$store.view.selectedMode === 'level'" class="mb-6 bg-pink-50 p-4 rounded-xl">
          <p class="text-gray-600">
            Start at Level 1 and work your way up! Get 8 out of 10 correct to advance.
            Difficulty increases as you progress.
          </p>
          <p class="mt-2 text-sm text-gray-500">
            Levels unlocked: <span class="font-bold text-pink-600" x-text="$store.profile.activeProfile?.stats.levelsUnlocked || 1"></span>
          </p>
        </div>

        <!-- Darab Mode Info -->
        <div x-show="$store.view.selectedMode === 'sifir'" class="mb-6 bg-amber-50 p-4 rounded-xl">
          <p class="text-gray-600">
            Master multiplication tables from 1 to 12! Start with Darab 1 (1√ó1 to 1√ó12),
            then progress to Darab 2, and so on.
          </p>
          <p class="mt-2 text-gray-600">
            Questions are randomized. Wrong answers repeat until you get them all correct!
          </p>
        </div>

        <!-- Bahagi Mode Info -->
        <div x-show="$store.view.selectedMode === 'bahagi'" class="mb-6 bg-emerald-50 p-4 rounded-xl">
          <p class="text-gray-600">
            Master division tables from 1 to 12! Start with Bahagi 1 (1√∑1 to 12√∑1),
            then progress to Bahagi 2, and so on.
          </p>
          <p class="mt-2 text-gray-600">
            Questions are randomized. Wrong answers repeat until you get them all correct!
          </p>
        </div>

        <!-- Tambah Mode Info -->
        <div x-show="$store.view.selectedMode === 'tambah'" class="mb-6 bg-blue-50 p-4 rounded-xl">
          <p class="text-gray-600">
            Master addition through all difficulty levels! Start with Easy (1-10),
            then progress to Medium (1-50), and finally Hard (1-100).
          </p>
          <p class="mt-2 text-gray-600">
            20 questions per level. Wrong answers repeat until you get them all correct!
          </p>
        </div>

        <!-- Tolak Mode Info -->
        <div x-show="$store.view.selectedMode === 'tolak'" class="mb-6 bg-rose-50 p-4 rounded-xl">
          <p class="text-gray-600">
            Master subtraction through all difficulty levels! Start with Easy (1-10),
            then progress to Medium (1-50), and finally Hard (1-100).
          </p>
          <p class="mt-2 text-gray-600">
            20 questions per level. Wrong answers repeat until you get them all correct!
          </p>
        </div>

        <!-- Previous Sessions -->
        <div x-data="{
          sessions: $store.profile.getIncompleteSessionsByMode($store.view.selectedMode),
          formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
          }
        }"
        x-init="sessions = $store.profile.getIncompleteSessionsByMode($store.view.selectedMode)"
        class="mb-6">
          <template x-if="sessions.length > 0">
            <div>
              <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                <span>üìã</span>
                <span>Resume Previous Session</span>
              </h3>
              <div class="space-y-2">
                <template x-for="session in sessions.slice(0, 3)" :key="session.gameId">
                  <div class="bg-gray-50 rounded-xl p-4 border-2 border-gray-200 hover:border-purple-300 transition-all">
                    <div class="flex items-center justify-between mb-2">
                      <div class="flex items-center gap-2">
                        <span class="text-xs font-mono text-gray-400" x-text="'#' + session.gameId.slice(-6)"></span>
                        <span class="text-xs text-gray-500" x-text="formatTime(session.lastUpdated)"></span>
                      </div>
                      <button
                        @click="$store.profile.deleteSession(session.gameId); sessions = $store.profile.getIncompleteSessionsByMode($store.view.selectedMode)"
                        class="text-red-400 hover:text-red-600 text-sm"
                        title="Delete session"
                      >
                        ‚úï
                      </button>
                    </div>

                    <div class="grid grid-cols-3 gap-2 mb-3 text-center text-xs">
                      <div>
                        <div class="font-bold text-purple-600" x-text="session.score || 0"></div>
                        <div class="text-gray-500">Score</div>
                      </div>
                      <div>
                        <div class="font-bold text-green-600" x-text="session.correctAnswers || 0"></div>
                        <div class="text-gray-500">Correct</div>
                      </div>
                      <div>
                        <div class="font-bold text-blue-600" x-text="(session.accuracy || 0) + '%'"></div>
                        <div class="text-gray-500">Accuracy</div>
                      </div>
                    </div>

                    <!-- Mode-specific info -->
                    <div class="text-xs text-gray-600 mb-3">
                      <template x-if="$store.view.selectedMode === 'sifir'">
                        <span>Darab <span x-text="session.currentSifir"></span></span>
                      </template>
                      <template x-if="$store.view.selectedMode === 'bahagi'">
                        <span>Bahagi <span x-text="session.currentBahagi"></span></span>
                      </template>
                      <template x-if="$store.view.selectedMode === 'tambah'">
                        <span class="capitalize" x-text="session.currentTambahDifficulty + ' Level'"></span>
                      </template>
                      <template x-if="$store.view.selectedMode === 'tolak'">
                        <span class="capitalize" x-text="session.currentTolakDifficulty + ' Level'"></span>
                      </template>
                      <template x-if="$store.view.selectedMode === 'level'">
                        <span>Level <span x-text="session.currentLevel"></span></span>
                      </template>
                      <template x-if="$store.view.selectedMode === 'timed'">
                        <span><span x-text="session.timeRemaining"></span>s remaining</span>
                      </template>
                    </div>

                    <button
                      @click="$store.game.resumeSession(session.gameId); $store.view.current = 'game'"
                      class="w-full bg-purple-500 hover:bg-purple-600 text-white text-sm py-2 px-4 rounded-lg font-bold transition-colors"
                    >
                      Resume Session
                    </button>
                  </div>
                </template>
              </div>
              <div class="mt-3 pt-3 border-t-2 border-gray-100 text-center">
                <div class="text-sm text-gray-500">or</div>
              </div>
            </div>
          </template>
        </div>

        <button @click="$store.view.startGame()" class="btn w-full text-xl py-4"
          :class="{
            'btn-primary': $store.view.selectedMode === 'practice',
            'btn-secondary': $store.view.selectedMode === 'timed',
            'btn-pink': $store.view.selectedMode === 'level',
            'bg-amber-500 hover:bg-amber-600': $store.view.selectedMode === 'sifir',
            'bg-emerald-500 hover:bg-emerald-600': $store.view.selectedMode === 'bahagi',
            'bg-blue-500 hover:bg-blue-600': $store.view.selectedMode === 'tambah',
            'bg-rose-500 hover:bg-rose-600': $store.view.selectedMode === 'tolak',
            'opacity-50 cursor-not-allowed': ($store.view.selectedMode === 'practice' || $store.view.selectedMode === 'timed') && $store.view.selectedOperations.length === 0
          }"
          :disabled="($store.view.selectedMode === 'practice' || $store.view.selectedMode === 'timed') && $store.view.selectedOperations.length === 0"
        >
          <span x-show="($store.view.selectedMode === 'practice' || $store.view.selectedMode === 'timed') && $store.view.selectedOperations.length === 0">Select an operation</span>
          <span x-show="$store.view.selectedMode === 'level' || $store.view.selectedMode === 'sifir' || $store.view.selectedMode === 'bahagi' || $store.view.selectedMode === 'tambah' || $store.view.selectedMode === 'tolak' || $store.view.selectedOperations.length > 0">Start New Session üöÄ</span>
        </button>
      </div>
    </div>

    <!-- Game Screen -->
    <div x-show="$store.view.current === 'game'" x-cloak class="min-h-screen flex items-center justify-center p-4">
      <div class="card max-w-lg w-full text-center">
        <!-- Game Header -->
        <div class="flex items-center justify-between gap-2 mb-4 flex-nowrap">
          <button @click="$store.view.goHome()" class="text-xl sm:text-2xl hover:scale-110 transition-transform shrink-0">‚úï</button>

          <!-- Mode-specific info -->
          <div class="flex items-center justify-center gap-2 sm:gap-4 flex-1 min-w-0 flex-nowrap">
            <!-- Timed mode: show timer -->
            <div x-show="$store.game.mode === 'timed'" class="flex items-center gap-2 bg-cyan-100 px-2 py-1 sm:px-4 sm:py-2 rounded-full min-w-0">
              <span class="text-xl sm:text-2xl">‚è±Ô∏è</span>
              <span class="font-bold text-base sm:text-xl text-cyan-600 truncate" x-text="$store.game.formattedTime"></span>
            </div>

            <!-- Level mode: show level -->
            <div x-show="$store.game.mode === 'level'" class="flex items-center gap-2 bg-pink-100 px-2 py-1 sm:px-4 sm:py-2 rounded-full min-w-0">
              <span class="text-xl sm:text-2xl">üèÜ</span>
              <span class="font-bold text-base sm:text-xl text-pink-600 truncate">Level <span x-text="$store.game.currentLevel"></span></span>
            </div>

            <!-- Darab mode: show current table -->
            <div x-show="$store.game.mode === 'sifir'" class="flex items-center gap-2 bg-amber-100 px-2 py-1 sm:px-4 sm:py-2 rounded-full min-w-0">
              <span class="text-xl sm:text-2xl">‚úñÔ∏è</span>
              <span class="font-bold text-base sm:text-xl text-amber-600 truncate">Darab <span x-text="$store.game.currentSifir"></span></span>
            </div>

            <!-- Bahagi mode: show current table -->
            <div x-show="$store.game.mode === 'bahagi'" class="flex items-center gap-2 bg-emerald-100 px-2 py-1 sm:px-4 sm:py-2 rounded-full min-w-0">
              <span class="text-xl sm:text-2xl">‚ûó</span>
              <span class="font-bold text-base sm:text-xl text-emerald-600 truncate">Bahagi <span x-text="$store.game.currentBahagi"></span></span>
            </div>

            <!-- Tambah mode: show current difficulty -->
            <div x-show="$store.game.mode === 'tambah'" class="flex items-center gap-2 bg-blue-100 px-2 py-1 sm:px-4 sm:py-2 rounded-full min-w-0">
              <span class="text-xl sm:text-2xl">‚ûï</span>
              <span class="font-bold text-base sm:text-xl text-blue-600 capitalize truncate" x-text="$store.game.currentTambahDifficulty"></span>
            </div>

            <!-- Tolak mode: show current difficulty -->
            <div x-show="$store.game.mode === 'tolak'" class="flex items-center gap-2 bg-rose-100 px-2 py-1 sm:px-4 sm:py-2 rounded-full min-w-0">
              <span class="text-xl sm:text-2xl">‚ûñ</span>
              <span class="font-bold text-base sm:text-xl text-rose-600 capitalize truncate" x-text="$store.game.currentTolakDifficulty"></span>
            </div>
          </div>

          <div class="flex items-center gap-2 sm:gap-4 shrink-0 flex-nowrap">
            <div class="flex items-center gap-1.5 bg-amber-100 px-2 py-1 sm:px-4 sm:py-2 rounded-full">
              <span class="text-base sm:text-xl">‚≠ê</span>
              <span class="font-bold text-sm sm:text-lg text-amber-600" x-text="$store.game.starsEarned"></span>
            </div>
            <div class="flex items-center gap-1.5 bg-purple-100 px-2 py-1 sm:px-4 sm:py-2 rounded-full">
              <span class="text-base sm:text-xl">üìä</span>
              <span class="font-bold text-sm sm:text-lg text-purple-600" x-text="$store.game.score"></span>
            </div>
          </div>
        </div>

        <!-- Progress bar for level mode -->
        <div x-show="$store.game.mode === 'level'" class="mb-4">
          <div class="progress-bar">
            <div class="progress-bar-fill" :style="'width: ' + $store.game.levelProgress + '%'"></div>
          </div>
          <div class="text-sm text-gray-500 mt-1">
            <span x-text="$store.game.correctInLevel"></span>/<span x-text="$store.game.levelPassThreshold"></span> correct
          </div>
        </div>

        <!-- Progress for sifir mode -->
        <div x-show="$store.game.mode === 'sifir'" class="mb-4">
          <div class="progress-bar">
            <div class="progress-bar-fill bg-gradient-to-r from-amber-500 to-orange-500" :style="'width: ' + $store.game.sifirProgress + '%'"></div>
          </div>
          <div class="text-sm text-gray-500 mt-1">
            <span x-text="$store.game.sifirQuestionsRemaining"></span> questions remaining
            <span x-show="$store.game.sifirWrongQuestions.length > 0" class="text-amber-600">
              (<span x-text="$store.game.sifirWrongQuestions.length"></span> to retry)
            </span>
          </div>
        </div>

        <!-- Progress for bahagi mode -->
        <div x-show="$store.game.mode === 'bahagi'" class="mb-4">
          <div class="progress-bar">
            <div class="progress-bar-fill bg-gradient-to-r from-emerald-500 to-teal-500" :style="'width: ' + $store.game.bahagiProgress + '%'"></div>
          </div>
          <div class="text-sm text-gray-500 mt-1">
            <span x-text="$store.game.bahagiQuestionsRemaining"></span> questions remaining
            <span x-show="$store.game.bahagiWrongQuestions.length > 0" class="text-emerald-600">
              (<span x-text="$store.game.bahagiWrongQuestions.length"></span> to retry)
            </span>
          </div>
        </div>

        <!-- Progress for tambah mode -->
        <div x-show="$store.game.mode === 'tambah'" class="mb-4">
          <div class="progress-bar">
            <div class="progress-bar-fill bg-gradient-to-r from-blue-500 to-indigo-500" :style="'width: ' + $store.game.tambahProgress + '%'"></div>
          </div>
          <div class="text-sm text-gray-500 mt-1">
            <span x-text="$store.game.tambahQuestionsRemaining"></span> questions remaining
            <span x-show="$store.game.tambahWrongQuestions.length > 0" class="text-blue-600">
              (<span x-text="$store.game.tambahWrongQuestions.length"></span> to retry)
            </span>
          </div>
        </div>

        <!-- Progress for tolak mode -->
        <div x-show="$store.game.mode === 'tolak'" class="mb-4">
          <div class="progress-bar">
            <div class="progress-bar-fill bg-gradient-to-r from-rose-500 to-red-500" :style="'width: ' + $store.game.tolakProgress + '%'"></div>
          </div>
          <div class="text-sm text-gray-500 mt-1">
            <span x-text="$store.game.tolakQuestionsRemaining"></span> questions remaining
            <span x-show="$store.game.tolakWrongQuestions.length > 0" class="text-rose-600">
              (<span x-text="$store.game.tolakWrongQuestions.length"></span> to retry)
            </span>
          </div>
        </div>

        <!-- Problem Display -->
        <div class="py-8" :class="{ 'animate-shake': $store.game.showFeedback && $store.game.lastResult === 'incorrect' }">
          <div x-show="$store.game.mode === 'tambah' || $store.game.mode === 'tolak'"
               class="text-6xl font-bold mb-8 flex flex-col items-end mx-auto w-40 sm:w-48"
               :class="{
                 'animate-bounce-in': $store.game.currentProblem,
                 'text-green-500': $store.game.showFeedback && $store.game.lastResult === 'correct',
                 'text-red-500': $store.game.showFeedback && $store.game.lastResult === 'incorrect'
               }">
            <span class="leading-none" x-text="$store.game.currentProblem?.num1"></span>
            <div class="flex items-center gap-3 leading-none">
              <span class="text-purple-400" x-text="$store.game.currentProblem?.symbol"></span>
              <span x-text="$store.game.currentProblem?.num2"></span>
            </div>
            <div class="w-full border-b-4 border-gray-300 my-2"></div>
            <div class="flex items-center gap-3 leading-none">
              <span class="text-gray-400">=</span>
              <span x-text="$store.game.showFeedback ? $store.game.currentProblem?.answer : '?'" class="text-purple-600"></span>
            </div>
          </div>

          <div x-show="$store.game.mode !== 'tambah' && $store.game.mode !== 'tolak'"
               class="text-6xl font-bold mb-8 flex items-center justify-center gap-4"
               :class="{
                 'animate-bounce-in': $store.game.currentProblem,
                 'text-green-500': $store.game.showFeedback && $store.game.lastResult === 'correct',
                 'text-red-500': $store.game.showFeedback && $store.game.lastResult === 'incorrect'
               }">
            <span x-text="$store.game.currentProblem?.num1"></span>
            <span class="text-purple-400" x-text="$store.game.currentProblem?.symbol"></span>
            <span x-text="$store.game.currentProblem?.num2"></span>
            <span class="text-gray-400">=</span>
            <span x-text="$store.game.showFeedback ? $store.game.currentProblem?.answer : '?'" class="text-purple-600"></span>
          </div>

          <!-- Answer Input -->
          <div x-show="!$store.game.showFeedback" class="flex items-center justify-center gap-4">
            <input
              type="number"
              inputmode="numeric"
              x-model="$store.game.userAnswer"
              x-ref="answerInput"
              x-init="$store.game.registerInput($refs.answerInput)"
              @keyup.enter="
                $store.game.mode === 'sifir' ? $store.game.submitSifirAnswer() :
                ($store.game.mode === 'bahagi' ? $store.game.submitBahagiAnswer() :
                ($store.game.mode === 'tambah' ? $store.game.submitTambahAnswer() :
                ($store.game.mode === 'tolak' ? $store.game.submitTolakAnswer() :
                $store.game.submitAnswer())))"
              class="answer-input"
              placeholder="?"
            />
            <button
              @click="
                $store.game.mode === 'sifir' ? $store.game.submitSifirAnswer() :
                ($store.game.mode === 'bahagi' ? $store.game.submitBahagiAnswer() :
                ($store.game.mode === 'tambah' ? $store.game.submitTambahAnswer() :
                ($store.game.mode === 'tolak' ? $store.game.submitTolakAnswer() :
                $store.game.submitAnswer())))"
              class="btn btn-success text-2xl px-8"
              :disabled="!$store.game.userAnswer"
            >
              ‚úì
            </button>
          </div>

          <!-- Feedback -->
          <div x-show="$store.game.showFeedback" class="text-4xl">
            <span x-show="$store.game.lastResult === 'correct'" class="text-green-500">‚úì Great!</span>
            <span x-show="$store.game.lastResult === 'incorrect'" class="text-red-500">‚úó Try again!</span>
          </div>
        </div>

        <!-- Pet Companion -->
        <div class="my-4">
          <div class="flex items-center justify-center gap-2">
            <div
              class="text-3xl transition-transform"
              :class="{
                'animate-bounce': $store.game.showFeedback && $store.game.lastResult === 'correct',
                'animate-hurt': $store.game.showFeedback && $store.game.lastResult === 'incorrect'
              }"
              x-text="PetSystem.getPetEmoji($store.profile.activeProfile?.pet?.stage || 0)"
            ></div>
            <div
              class="text-sm"
              :class="$store.game.showFeedback && $store.game.lastResult === 'incorrect' ? 'text-red-500' : 'text-gray-500'"
              x-text="$store.game.showFeedback && $store.game.lastResult === 'incorrect'
                ? ($store.profile.activeProfile?.pet?.name || 'Nora') + ' feels sad...'
                : ($store.profile.activeProfile?.pet?.name || 'Nora') + ' is cheering you on!'"
            ></div>
          </div>
          <div x-show="$store.game.petDevolved" class="text-xs text-red-500 mt-1">
            üòø <span x-text="$store.profile.activeProfile?.pet?.name || 'Nora'"></span> devolved to
            <span x-text="PetSystem.getPetStageName($store.game.petDevolutionData?.newStage || 0)"></span>.
          </div>
          <div x-show="$store.game.petDevolutionWarning && !$store.game.petDevolved" class="text-xs text-amber-600 mt-1"
               x-text="'‚ö†Ô∏è ' + ($store.profile.activeProfile?.pet?.name || 'Nora') + ' is ' + ($store.game.petDevolutionWarning?.mistakesRemaining || 1) + ' mistake' + (($store.game.petDevolutionWarning?.mistakesRemaining || 1) === 1 ? '' : 's') + ' away from devolving.'">
          </div>
        </div>

        <!-- Stats Bar -->
        <div class="flex justify-center gap-8 text-center border-t-2 border-purple-100 pt-4">
          <div>
            <div class="text-2xl font-bold text-gray-700" x-text="$store.game.correctAnswers"></div>
            <div class="text-xs text-gray-500">Correct</div>
          </div>
          <div>
            <div class="text-2xl font-bold text-gray-700" x-text="$store.game.problemsAttempted"></div>
            <div class="text-xs text-gray-500">Attempted</div>
          </div>
          <div>
            <div class="text-2xl font-bold"
                 :class="$store.game.accuracy >= 80 ? 'text-green-500' : ($store.game.accuracy >= 50 ? 'text-yellow-500' : 'text-red-500')"
                 x-text="$store.game.accuracy + '%'"></div>
            <div class="text-xs text-gray-500">Accuracy</div>
          </div>
        </div>

        <!-- Game ID Display -->
        <div class="mt-4 text-center">
          <div class="inline-flex items-center gap-2 bg-gray-100 px-3 py-1 rounded-full">
            <span class="text-xs text-gray-500">Game ID:</span>
            <span class="text-xs font-mono text-gray-700" x-text="$store.game.gameId"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Screen -->
    <div x-show="$store.view.current === 'game' && !$store.game.isPlaying && $store.game.problemsAttempted > 0" x-cloak
         class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
      <div class="card max-w-md w-full text-center animate-bounce-in">
        <h2 class="text-3xl font-bold text-purple-600 mb-2">
          <span x-show="$store.game.mode === 'timed'">‚è±Ô∏è Time's Up!</span>
          <span x-show="$store.game.mode === 'level' && $store.game.correctInLevel >= $store.game.levelPassThreshold">üéâ Level Complete!</span>
          <span x-show="$store.game.mode === 'level' && $store.game.correctInLevel < $store.game.levelPassThreshold">Keep Practicing!</span>
          <span x-show="$store.game.mode === 'practice'">Awesome Work!</span>
          <span x-show="$store.game.mode === 'sifir' && $store.game.sifirCompleted">üèÜ All Darab Mastered!</span>
          <span x-show="$store.game.mode === 'sifir' && !$store.game.sifirCompleted">‚úñÔ∏è Darab <span x-text="$store.game.currentSifir"></span> Complete!</span>
          <span x-show="$store.game.mode === 'bahagi' && $store.game.bahagiCompleted">üèÜ All Bahagi Mastered!</span>
          <span x-show="$store.game.mode === 'bahagi' && !$store.game.bahagiCompleted">‚ûó Bahagi <span x-text="$store.game.currentBahagi"></span> Complete!</span>
          <span x-show="$store.game.mode === 'tambah' && $store.game.tambahCompleted">üèÜ All Tambah Levels Mastered!</span>
          <span x-show="$store.game.mode === 'tambah' && !$store.game.tambahCompleted">‚ûï <span class="capitalize" x-text="$store.game.currentTambahDifficulty"></span> Tambah Complete!</span>
          <span x-show="$store.game.mode === 'tolak' && $store.game.tolakCompleted">üèÜ All Tolak Levels Mastered!</span>
          <span x-show="$store.game.mode === 'tolak' && !$store.game.tolakCompleted">‚ûñ <span class="capitalize" x-text="$store.game.currentTolakDifficulty"></span> Tolak Complete!</span>
        </h2>

        <div class="text-6xl my-6">
          <span x-show="$store.game.accuracy >= 80">üåü</span>
          <span x-show="$store.game.accuracy >= 50 && $store.game.accuracy < 80">üëç</span>
          <span x-show="$store.game.accuracy < 50">üí™</span>
        </div>

        <!-- Milestone Celebrations -->
        <div x-show="$store.game.milestonesAchieved.length > 0" class="space-y-3 mb-6">
          <template x-for="milestone in $store.game.milestonesAchieved" :key="milestone.id">
            <div class="bg-gradient-to-r from-yellow-400 to-orange-400 p-6 rounded-2xl animate-bounce-in">
              <div class="text-white text-6xl mb-3" x-text="milestone.emoji"></div>
              <div class="text-white text-2xl font-extrabold mb-1" x-text="milestone.message"></div>
              <div class="text-yellow-100 text-lg">
                Bonus: +<span x-text="milestone.reward"></span> ‚≠ê
              </div>
            </div>
          </template>
        </div>

        <!-- Pet Evolution Celebration -->
        <div x-show="$store.game.petEvolved" class="bg-gradient-to-r from-pink-400 to-purple-400 p-6 rounded-2xl mb-6 animate-bounce-in">
          <div class="text-white text-6xl mb-3">
            <span x-text="PetSystem.getPetEmoji($store.game.petEvolutionData?.newStage || 0)"></span>
          </div>
          <div class="text-white text-2xl font-extrabold mb-1">
            Pet Evolved!
          </div>
          <div class="text-pink-100 text-lg">
            <span x-text="($store.profile.activeProfile?.pet?.name || 'Nora')"></span> is now a
            <span x-text="PetSystem.getPetStageName($store.game.petEvolutionData?.newStage || 0)"></span>!
          </div>
        </div>

        <!-- Stars Earned -->
        <div class="bg-gradient-to-r from-amber-400 to-yellow-400 p-6 rounded-2xl mb-6">
          <div class="text-white text-5xl font-extrabold mb-2">
            +<span x-text="$store.game.starsEarned"></span> ‚≠ê
          </div>
          <div class="text-amber-100 text-sm space-y-1">
            <div x-show="$store.game.starBreakdown.base > 0">
              Base: +<span x-text="$store.game.starBreakdown.base"></span>
            </div>
            <div x-show="$store.game.starBreakdown.accuracyBonus > 0">
              Accuracy Bonus: +<span x-text="$store.game.starBreakdown.accuracyBonus"></span>
            </div>
            <div x-show="$store.game.starBreakdown.completionBonus > 0">
              Completion Bonus: +<span x-text="$store.game.starBreakdown.completionBonus"></span>
            </div>
            <div x-show="$store.game.starBreakdown.streakBonus > 0">
              Streak Bonus: +<span x-text="$store.game.starBreakdown.streakBonus"></span>
            </div>
          </div>
          <div class="text-white text-sm mt-3 pt-3 border-t border-amber-300">
            Total Stars: <span class="font-bold" x-text="$store.profile.activeProfile?.stats.stars || 0"></span>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="bg-purple-50 p-4 rounded-xl">
            <div class="text-3xl font-bold text-purple-600" x-text="$store.game.score"></div>
            <div class="text-sm text-gray-500">Points</div>
          </div>
          <div class="bg-green-50 p-4 rounded-xl">
            <div class="text-3xl font-bold text-green-500" x-text="$store.game.accuracy + '%'"></div>
            <div class="text-sm text-gray-500">Accuracy</div>
          </div>
          <div class="bg-blue-50 p-4 rounded-xl">
            <div class="text-3xl font-bold text-blue-500" x-text="$store.game.correctAnswers"></div>
            <div class="text-sm text-gray-500">Correct</div>
          </div>
          <div class="bg-orange-50 p-4 rounded-xl">
            <div class="text-3xl font-bold text-orange-500" x-text="$store.game.problemsAttempted"></div>
            <div class="text-sm text-gray-500">Total</div>
          </div>
        </div>

        <div class="flex gap-3">
          <button @click="$store.view.goHome()" class="btn bg-gray-300 hover:bg-gray-400 flex-1">
            Menu
          </button>
          <button @click="$store.view.startGame()" class="btn btn-primary flex-1">
            Play Again
          </button>
        </div>
      </div>
    </div>

    <!-- Pet Screen -->
    <div x-show="$store.view.current === 'pet'" x-cloak class="min-h-screen p-4 py-8"
         x-data="{
           editingName: false,
           newPetName: ''
         }">
      <div class="max-w-md mx-auto">
        <div class="card mb-4">
          <div class="flex items-center justify-between mb-6">
            <button @click="$store.view.current = 'menu'" class="text-2xl hover:scale-110 transition-transform">‚Üê</button>
            <h2 class="text-2xl font-bold text-purple-600">üê£ Your Math Buddy</h2>
            <div></div>
          </div>

          <!-- Pet Display -->
          <div class="text-center mb-6">
            <div class="text-9xl mb-4" x-text="PetSystem.getPetEmoji($store.profile.activeProfile?.pet?.stage || 0)"></div>

            <!-- Pet Name (editable) -->
            <div x-show="!editingName" class="mb-2">
              <div class="text-2xl font-bold text-purple-700 inline-flex items-center gap-2">
                <span x-text="$store.profile.activeProfile?.pet?.name || 'Nora'"></span>
                <button
                  @click="editingName = true; newPetName = $store.profile.activeProfile?.pet?.name || 'Nora'"
                  class="text-sm text-purple-500 hover:text-purple-700"
                >
                  üìù Edit
                </button>
              </div>
            </div>

            <!-- Edit Name Input -->
            <div x-show="editingName" class="mb-2">
              <input
                type="text"
                x-model="newPetName"
                @keyup.enter="$store.profile.updatePetName(newPetName); editingName = false"
                @keyup.escape="editingName = false"
                class="text-2xl font-bold text-center px-4 py-2 rounded-xl border-2 border-purple-300 focus:border-purple-500 focus:outline-none"
                maxlength="20"
                x-effect="if (editingName) $nextTick(() => $el.focus())"
              />
              <div class="flex gap-2 justify-center mt-2">
                <button
                  @click="$store.profile.updatePetName(newPetName); editingName = false"
                  class="btn btn-success text-sm px-4 py-1"
                >
                  ‚úì Save
                </button>
                <button
                  @click="editingName = false"
                  class="btn bg-gray-300 hover:bg-gray-400 text-sm px-4 py-1"
                >
                  Cancel
                </button>
              </div>
            </div>

            <div class="text-lg text-purple-600 mb-4">
              Stage <span x-text="($store.profile.activeProfile?.pet?.stage || 0) + 1"></span>/5:
              <span x-text="PetSystem.getPetStageName($store.profile.activeProfile?.pet?.stage || 0)"></span>
            </div>

            <div class="text-sm text-gray-600" x-text="PetSystem.getPetMessage($store.profile.activeProfile?.pet?.stage || 0)"></div>
          </div>

          <!-- Evolution Progress -->
          <div class="mb-6 px-4">
            <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
              <span>Evolution Progress</span>
              <span x-text="PetSystem.getEvolutionProgress($store.profile.activeProfile?.pet?.xp || 0) + '%'"></span>
            </div>
            <div class="h-4 bg-purple-200 rounded-full overflow-hidden">
              <div
                class="h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all"
                :style="'width: ' + PetSystem.getEvolutionProgress($store.profile.activeProfile?.pet?.xp || 0) + '%'"
              ></div>
            </div>
            <div class="text-xs text-gray-500 mt-2 text-center">
              <span x-text="PetSystem.getProblemsToNextEvolution($store.profile.activeProfile?.pet?.xp || 0)"></span> more problems to evolve!
            </div>
            <div
              x-show="($store.profile.activeProfile?.pet?.stage || 0) > 0 && ($store.profile.activeProfile?.pet?.devolutionRisk || 0) >= (PetSystem.DEVOLUTION_THRESHOLD - 1)"
              class="text-xs text-amber-600 mt-2 text-center"
              x-text="'‚ö†Ô∏è ' + ($store.profile.activeProfile?.pet?.name || 'Nora') + ' is ' + Math.max(0, PetSystem.DEVOLUTION_THRESHOLD - ($store.profile.activeProfile?.pet?.devolutionRisk || 0)) + ' mistake' + (Math.max(0, PetSystem.DEVOLUTION_THRESHOLD - ($store.profile.activeProfile?.pet?.devolutionRisk || 0)) === 1 ? '' : 's') + ' away from devolving.'"
            ></div>
          </div>

          <!-- Pet Stats -->
          <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="bg-purple-50 p-3 rounded-xl text-center">
              <div class="text-2xl font-bold text-purple-600" x-text="$store.profile.activeProfile?.pet?.xp || 0"></div>
              <div class="text-xs text-gray-500">Total XP</div>
            </div>
            <div class="bg-pink-50 p-3 rounded-xl text-center">
              <div class="text-2xl font-bold text-pink-600" x-text="$store.profile.activeProfile?.stats.totalProblems || 0"></div>
              <div class="text-xs text-gray-500">Problems Solved</div>
            </div>
          </div>

          <!-- Interaction Buttons -->
          <div class="space-y-3">
            <button
              @click="if ($store.profile.feedPet()) { alert('üçï ' + ($store.profile.activeProfile?.pet?.name || 'Nora') + ' enjoyed the treat!') }"
              :disabled="($store.profile.activeProfile?.stats.stars || 0) < 10"
              class="w-full btn transition-all"
              :class="($store.profile.activeProfile?.stats.stars || 0) >= 10 ? 'bg-amber-500 hover:bg-amber-600 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'"
            >
              <span class="text-xl">üçï</span>
              Feed Pet (10 ‚≠ê)
            </button>

            <button
              @click="if ($store.profile.playWithPet()) { alert('üéÆ You played with ' + ($store.profile.activeProfile?.pet?.name || 'Nora') + '!') }"
              :disabled="($store.profile.activeProfile?.stats.stars || 0) < 5"
              class="w-full btn transition-all"
              :class="($store.profile.activeProfile?.stats.stars || 0) >= 5 ? 'bg-purple-500 hover:bg-purple-600 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'"
            >
              <span class="text-xl">üéÆ</span>
              Play with Pet (5 ‚≠ê)
            </button>
          </div>

          <!-- Evolution Guide -->
          <div class="mt-6 pt-6 border-t-2 border-purple-100">
            <div class="text-sm font-bold text-gray-700 mb-3 text-center">Evolution Stages</div>
            <div class="space-y-2 text-sm">
              <div class="flex items-center gap-3 p-2 rounded-lg" :class="($store.profile.activeProfile?.pet?.stage || 0) === 0 ? 'bg-purple-100' : ''">
                <span class="text-2xl">ü•ö</span>
                <div>
                  <div class="font-bold">Egg (0-24 problems)</div>
                  <div class="text-xs text-gray-500">Your journey begins!</div>
                </div>
              </div>
              <div class="flex items-center gap-3 p-2 rounded-lg" :class="($store.profile.activeProfile?.pet?.stage || 0) === 1 ? 'bg-purple-100' : ''">
                <span class="text-2xl">üê£</span>
                <div>
                  <div class="font-bold">Baby (25-99 problems)</div>
                  <div class="text-xs text-gray-500">First steps!</div>
                </div>
              </div>
              <div class="flex items-center gap-3 p-2 rounded-lg" :class="($store.profile.activeProfile?.pet?.stage || 0) === 2 ? 'bg-purple-100' : ''">
                <span class="text-2xl">üê§</span>
                <div>
                  <div class="font-bold">Kid (100-299 problems)</div>
                  <div class="text-xs text-gray-500">Learning fast!</div>
                </div>
              </div>
              <div class="flex items-center gap-3 p-2 rounded-lg" :class="($store.profile.activeProfile?.pet?.stage || 0) === 3 ? 'bg-purple-100' : ''">
                <span class="text-2xl">üê¶</span>
                <div>
                  <div class="font-bold">Teen (300-499 problems)</div>
                  <div class="text-xs text-gray-500">Getting stronger!</div>
                </div>
              </div>
              <div class="flex items-center gap-3 p-2 rounded-lg" :class="($store.profile.activeProfile?.pet?.stage || 0) === 4 ? 'bg-purple-100' : ''">
                <span class="text-2xl">ü¶Ö</span>
                <div>
                  <div class="font-bold">Adult (500-999 problems)</div>
                  <div class="text-xs text-gray-500">Fully grown!</div>
                </div>
              </div>
              <div class="flex items-center gap-3 p-2 rounded-lg" :class="($store.profile.activeProfile?.pet?.stage || 0) === 5 ? 'bg-purple-100' : ''">
                <span class="text-2xl">üêâ</span>
                <div>
                  <div class="font-bold">Legendary (1000+ problems)</div>
                  <div class="text-xs text-gray-500">Dragon power!</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Shop Screen -->
    <div x-show="$store.view.current === 'shop'" x-cloak class="min-h-screen p-4 py-8">
      <div class="max-w-2xl mx-auto">
        <div class="card mb-4">
          <div class="flex items-center justify-between mb-6">
            <button @click="$store.view.current = 'menu'" class="text-2xl hover:scale-110 transition-transform">‚Üê</button>
            <h2 class="text-2xl font-bold text-purple-600">üè™ Shop</h2>
            <div></div>
          </div>

          <!-- Star Balance -->
          <div class="bg-gradient-to-r from-amber-400 to-yellow-400 p-6 rounded-2xl mb-6 text-center">
            <div class="text-white text-sm mb-1">Your Stars</div>
            <div class="text-white text-5xl font-extrabold">
              <span x-text="$store.profile.activeProfile?.stats.stars || 0"></span> ‚≠ê
            </div>
          </div>

          <!-- Shop Tabs -->
          <div class="mb-6">
            <div class="flex gap-2 border-b-2 border-purple-100 overflow-x-auto">
              <button
                @click="$store.shop.activeTab = 'avatars'"
                class="px-4 py-2 font-bold transition-colors whitespace-nowrap"
                :class="$store.shop.activeTab === 'avatars' ? 'text-purple-600 border-b-2 border-purple-600 -mb-0.5' : 'text-gray-400 hover:text-gray-600'"
              >
                Avatars
              </button>
              <button
                @click="$store.shop.activeTab = 'themes'"
                class="px-4 py-2 font-bold transition-colors whitespace-nowrap"
                :class="$store.shop.activeTab === 'themes' ? 'text-purple-600 border-b-2 border-purple-600 -mb-0.5' : 'text-gray-400 hover:text-gray-600'"
              >
                Themes
              </button>
              <button
                @click="$store.shop.activeTab = 'soundPacks'"
                class="px-4 py-2 font-bold transition-colors whitespace-nowrap"
                :class="$store.shop.activeTab === 'soundPacks' ? 'text-purple-600 border-b-2 border-purple-600 -mb-0.5' : 'text-gray-400 hover:text-gray-600'"
              >
                Sounds
              </button>
            </div>
          </div>

          <!-- Avatar Grid -->
          <div x-show="$store.shop.activeTab === 'avatars'">
            <div class="grid grid-cols-3 sm:grid-cols-4 gap-4">
              <template x-for="item in $store.shop.avatarItems" :key="item.id">
                <div class="relative">
                  <!-- Avatar Card -->
                  <div
                    class="bg-purple-50 rounded-2xl p-4 text-center border-2 transition-all"
                    :class="{
                      'border-purple-400 bg-purple-100': $store.shop.isEquipped('avatars', item.id),
                      'border-purple-200': !$store.shop.isEquipped('avatars', item.id),
                      'opacity-50': !$store.shop.isUnlocked('avatars', item.id) && !$store.shop.canAfford(item.price)
                    }"
                  >
                    <!-- Avatar Emoji -->
                    <div class="text-5xl mb-2" x-text="item.id"></div>

                    <!-- Avatar Name -->
                    <div class="text-xs font-bold text-gray-700 mb-2" x-text="item.name"></div>

                    <!-- Price or Status -->
                    <div class="text-sm">
                      <!-- Equipped -->
                      <template x-if="$store.shop.isEquipped('avatars', item.id)">
                        <div class="text-purple-600 font-bold text-xs">‚úì Equipped</div>
                      </template>

                      <!-- Unlocked but not equipped -->
                      <template x-if="$store.shop.isUnlocked('avatars', item.id) && !$store.shop.isEquipped('avatars', item.id)">
                        <button
                          @click="$store.shop.equipItem('avatars', item.id)"
                          class="w-full bg-purple-500 hover:bg-purple-600 text-white text-xs py-1 px-2 rounded-lg font-bold transition-colors"
                        >
                          Equip
                        </button>
                      </template>

                      <!-- Not unlocked -->
                      <template x-if="!$store.shop.isUnlocked('avatars', item.id)">
                        <div>
                          <!-- Can afford -->
                          <template x-if="$store.shop.canAfford(item.price)">
                            <button
                              @click="$store.shop.purchaseItem('avatars', item.id, item.price)"
                              class="w-full bg-amber-500 hover:bg-amber-600 text-white text-xs py-1 px-2 rounded-lg font-bold transition-colors"
                            >
                              <span x-text="item.price"></span> ‚≠ê
                            </button>
                          </template>

                          <!-- Cannot afford -->
                          <template x-if="!$store.shop.canAfford(item.price)">
                            <div class="text-gray-400 text-xs font-bold">
                              üîí <span x-text="item.price"></span> ‚≠ê
                            </div>
                          </template>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>
              </template>
            </div>

            <!-- Tier Legend -->
            <div class="mt-6 pt-6 border-t-2 border-purple-100 text-center text-sm text-gray-500">
              <div class="mb-2 font-bold">Price Tiers:</div>
              <div class="flex flex-wrap justify-center gap-4">
                <span>Tier 1: 50 ‚≠ê</span>
                <span>Tier 2: 100 ‚≠ê</span>
                <span>Tier 3: 200 ‚≠ê</span>
                <span class="text-amber-600 font-bold">Tier 4: 500 ‚≠ê</span>
              </div>
            </div>
          </div>

          <!-- Themes Grid -->
          <div x-show="$store.shop.activeTab === 'themes'">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <template x-for="item in $store.shop.themeItems" :key="item.id">
                <div
                  class="bg-purple-50 rounded-2xl p-6 border-2 transition-all"
                  :class="{
                    'border-purple-400 bg-purple-100': $store.shop.isEquipped('themes', item.id),
                    'border-purple-200': !$store.shop.isEquipped('themes', item.id)
                  }"
                >
                  <!-- Theme Preview -->
                  <div class="mb-4">
                    <div
                      class="h-20 rounded-xl bg-gradient-to-r"
                      :class="'bg-gradient-to-r ' + item.gradient"
                    ></div>
                  </div>

                  <!-- Theme Name -->
                  <div class="text-lg font-bold text-gray-700 mb-2" x-text="item.name"></div>

                  <!-- Price or Status -->
                  <div>
                    <!-- Equipped -->
                    <template x-if="$store.shop.isEquipped('themes', item.id)">
                      <div class="text-purple-600 font-bold text-sm">‚úì Equipped</div>
                    </template>

                    <!-- Unlocked but not equipped -->
                    <template x-if="$store.shop.isUnlocked('themes', item.id) && !$store.shop.isEquipped('themes', item.id)">
                      <button
                        @click="$store.shop.equipItem('themes', item.id); Themes.applyTheme(item.id)"
                        class="w-full bg-purple-500 hover:bg-purple-600 text-white text-sm py-2 px-4 rounded-lg font-bold transition-colors"
                      >
                        Equip
                      </button>
                    </template>

                    <!-- Not unlocked -->
                    <template x-if="!$store.shop.isUnlocked('themes', item.id)">
                      <div>
                        <!-- Can afford -->
                        <template x-if="$store.shop.canAfford(item.price)">
                          <button
                            @click="$store.shop.purchaseItem('themes', item.id, item.price)"
                            class="w-full bg-amber-500 hover:bg-amber-600 text-white text-sm py-2 px-4 rounded-lg font-bold transition-colors"
                          >
                            <span x-text="item.price"></span> ‚≠ê
                          </button>
                        </template>

                        <!-- Cannot afford -->
                        <template x-if="!$store.shop.canAfford(item.price)">
                          <div class="text-gray-400 text-sm font-bold text-center">
                            üîí <span x-text="item.price"></span> ‚≠ê
                          </div>
                        </template>
                      </div>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- Sound Packs Grid -->
          <div x-show="$store.shop.activeTab === 'soundPacks'">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <template x-for="item in $store.shop.soundPackItems" :key="item.id">
                <div
                  class="bg-purple-50 rounded-2xl p-6 border-2 transition-all"
                  :class="{
                    'border-purple-400 bg-purple-100': $store.shop.isEquipped('soundPacks', item.id),
                    'border-purple-200': !$store.shop.isEquipped('soundPacks', item.id)
                  }"
                >
                  <!-- Sound Icon -->
                  <div class="text-6xl mb-4 text-center">üîä</div>

                  <!-- Sound Pack Name & Description -->
                  <div class="text-lg font-bold text-gray-700 mb-1" x-text="item.name"></div>
                  <div class="text-sm text-gray-500 mb-4" x-text="item.description"></div>

                  <!-- Price or Status -->
                  <div>
                    <!-- Equipped -->
                    <template x-if="$store.shop.isEquipped('soundPacks', item.id)">
                      <div class="text-purple-600 font-bold text-sm">‚úì Equipped</div>
                    </template>

                    <!-- Unlocked but not equipped -->
                    <template x-if="$store.shop.isUnlocked('soundPacks', item.id) && !$store.shop.isEquipped('soundPacks', item.id)">
                      <button
                        @click="$store.shop.equipItem('soundPacks', item.id)"
                        class="w-full bg-purple-500 hover:bg-purple-600 text-white text-sm py-2 px-4 rounded-lg font-bold transition-colors"
                      >
                        Equip
                      </button>
                    </template>

                    <!-- Not unlocked -->
                    <template x-if="!$store.shop.isUnlocked('soundPacks', item.id)">
                      <div>
                        <!-- Can afford -->
                        <template x-if="$store.shop.canAfford(item.price)">
                          <button
                            @click="$store.shop.purchaseItem('soundPacks', item.id, item.price)"
                            class="w-full bg-amber-500 hover:bg-amber-600 text-white text-sm py-2 px-4 rounded-lg font-bold transition-colors"
                          >
                            <span x-text="item.price"></span> ‚≠ê
                          </button>
                        </template>

                        <!-- Cannot afford -->
                        <template x-if="!$store.shop.canAfford(item.price)">
                          <div class="text-gray-400 text-sm font-bold text-center">
                            üîí <span x-text="item.price"></span> ‚≠ê
                          </div>
                        </template>
                      </div>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Screen -->
    <div x-show="$store.view.current === 'stats'" x-cloak class="min-h-screen p-4 py-8">
      <div class="max-w-md mx-auto">
        <div class="card mb-4">
          <div class="flex items-center justify-between mb-4">
            <button @click="$store.view.current = 'menu'" class="text-2xl hover:scale-110 transition-transform">‚Üê</button>
            <h2 class="text-xl font-bold text-purple-600">üìä Your Stats</h2>
            <div></div>
          </div>

          <div class="flex items-center gap-4 mb-6 pb-4 border-b-2 border-purple-100">
            <span class="text-5xl" x-text="$store.profile.activeProfile?.avatar"></span>
            <div>
              <div class="font-bold text-xl" x-text="$store.profile.activeProfile?.name"></div>
              <div class="text-gray-500 text-sm">Playing since <span x-text="new Date($store.profile.activeProfile?.createdAt).toLocaleDateString()"></span></div>
            </div>
          </div>

          <!-- Overall Stats -->
          <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="bg-purple-50 p-3 rounded-xl text-center">
              <div class="text-2xl font-bold text-purple-600" x-text="$store.profile.activeProfile?.stats.totalProblems || 0"></div>
              <div class="text-xs text-gray-500">Problems Solved</div>
            </div>
            <div class="bg-green-50 p-3 rounded-xl text-center">
              <div class="text-2xl font-bold text-green-500" x-text="$store.profile.getAccuracy() + '%'"></div>
              <div class="text-xs text-gray-500">Overall Accuracy</div>
            </div>
            <div class="bg-orange-50 p-3 rounded-xl text-center">
              <div class="text-2xl font-bold text-orange-500" x-text="$store.profile.activeProfile?.stats.bestStreak || 0"></div>
              <div class="text-xs text-gray-500">Best Streak</div>
            </div>
            <div class="bg-pink-50 p-3 rounded-xl text-center">
              <div class="text-2xl font-bold text-pink-500" x-text="$store.profile.activeProfile?.stats.levelsUnlocked || 1"></div>
              <div class="text-xs text-gray-500">Levels Unlocked</div>
            </div>
          </div>
        </div>

        <!-- By Operation -->
        <div class="card mb-4">
          <h3 class="font-bold text-gray-700 mb-3">By Operation</h3>
          <div class="space-y-2">
            <template x-for="(symbol, op) in OPERATION_SYMBOLS" :key="op">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-lg font-bold text-purple-600" x-text="symbol"></div>
                <div class="flex-1">
                  <div class="flex justify-between text-sm mb-1">
                    <span class="capitalize" x-text="op === 'add' ? 'Addition' : (op === 'subtract' ? 'Subtraction' : (op === 'multiply' ? 'Multiplication' : 'Division'))"></span>
                    <span x-text="$store.profile.getAccuracy(op) + '%'"></span>
                  </div>
                  <div class="progress-bar h-2">
                    <div class="progress-bar-fill" :style="'width: ' + $store.profile.getAccuracy(op) + '%'"></div>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- High Scores -->
        <div class="card">
          <h3 class="font-bold text-gray-700 mb-3">High Scores</h3>
          <div class="grid grid-cols-2 gap-3">
            <div class="bg-cyan-50 p-3 rounded-xl text-center">
              <div class="text-2xl font-bold text-cyan-600" x-text="$store.profile.activeProfile?.stats.highScores.timed || 0"></div>
              <div class="text-xs text-gray-500">‚è±Ô∏è Timed Best</div>
            </div>
            <div class="bg-pink-50 p-3 rounded-xl text-center">
              <div class="text-2xl font-bold text-pink-600" x-text="'Level ' + ($store.profile.activeProfile?.stats.highScores.level || 1)"></div>
              <div class="text-xs text-gray-500">üèÜ Level Best</div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script type="module" src="/src/main.js"></script>
</body>
</html>
